<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&#34;Un-push&#34; Batch From Production - Newspaper Curation App</title>
<meta name="description" content="Safely removing generated batches from production">
<meta name="generator" content="Hugo 0.117.0">
<link rel="canonical" href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/undo-batch-golive/">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/theme.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/chroma.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/treeview-navigation.css">
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/headerlink.js"></script>
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/treeview-navigation.js"></script><meta property="og:title" content="&#34;Un-push&#34; Batch From Production" />
<meta property="og:description" content="Safely removing generated batches from production" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/undo-batch-golive/" /><meta property="article:section" content="workflow" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="&#34;Un-push&#34; Batch From Production"/>
<meta name="twitter:description" content="Safely removing generated batches from production"/>
<meta itemprop="name" content="&#34;Un-push&#34; Batch From Production">
<meta itemprop="description" content="Safely removing generated batches from production">

<meta itemprop="wordCount" content="553">
<meta itemprop="keywords" content="" /></head>
<body>
  <div class="container"><div class="skip"><a href="#maincontent">Skip to main content</a></div>
<header>
<h1>Newspaper Curation App</h1><a href="https://github.com/uoregon-libraries/newspaper-curation-app/" class="github"><img src="https://uoregon-libraries.github.io/newspaper-curation-app/images/github-mark-white.svg" alt="NCA on Github"></a>
</header>
<div class="content-container"><div class="sidebar">
  
  <nav aria-labelledby="table-of-contents">
    <h2 id="table-of-contents" class="sr-only">Table Of Contents</h2>
    <ul class="treeview-navigation" role="tree" aria-label="Contents">
      <li role="none">
        <a role="treeitem"  href="https://uoregon-libraries.github.io/newspaper-curation-app/">
          <span class="label">Home</span>
        </a>
      </li><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/"
        aria-owns="subtree--newspaper-curation-app-setup-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Setup and Installation
        </span>
      </a><ul role="group" aria-label="Setup and Installation" id="subtree--newspaper-curation-app-setup-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/services/"
        >
        <span class="label">Services and Apps
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/server-setup/"
        >
        <span class="label">Server Setup
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/installation/"
        >
        <span class="label">Installation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/user-setup/"
        >
        <span class="label">Users
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/creating-publishers/"
        >
        <span class="label">Onboarding A Publisher
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/sftpgo-integration/"
        >
        <span class="label">SFTPGo Integration
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/"
        aria-owns="subtree--newspaper-curation-app-specs-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>NCA Terms, Specs, and Information
        </span>
      </a><ul role="group" aria-label="NCA Terms, Specs, and Information" id="subtree--newspaper-curation-app-specs-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/glossary/"
        >
        <span class="label">Glossary
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/upload-specs/"
        >
        <span class="label">Uploads: Folder and File Specs
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/"
        aria-owns="subtree--newspaper-curation-app-workflow-"
          aria-expanded="true">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Workflow
        </span>
      </a><ul role="group" aria-label="Workflow" id="subtree--newspaper-curation-app-workflow-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/"
        >
        <span class="label">Technical Details
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/adding-titles/"
        >
        <span class="label">Adding Titles
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/handling-page-review-problems/"
        >
        <span class="label">Handling Page Review Problems
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-stuck-issues/"
        >
        <span class="label">Fixing &#34;Stuck&#34; Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-flagged-workflow-issues/"
        >
        <span class="label">Fixing Flagged Workflow Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-live-batches/"
        >
        <span class="label">Replacing Live Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/undo-batch-golive/"
        aria-current="page"
        >
        <span class="label">&#34;Un-push&#34; Batch From Production
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/"
        aria-owns="subtree--newspaper-curation-app-contributing-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Contributing
        </span>
      </a><ul role="group" aria-label="Contributing" id="subtree--newspaper-curation-app-contributing-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-guide/"
        >
        <span class="label">Developer&#39;s Guide
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/not-compiling-locally/"
        >
        <span class="label">Not Compiling Locally
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/documentation/"
        >
        <span class="label">Contributing to Documentation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/testing/"
        >
        <span class="label">Testing
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/"
        aria-owns="subtree--newspaper-curation-app-contributing-dev-howto-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>How do I...?
        </span>
      </a><ul role="group" aria-label="How do I...?" id="subtree--newspaper-curation-app-contributing-dev-howto-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-job-types/"
        >
        <span class="label">Add Job Types
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-config-items/"
        >
        <span class="label">Add Configuration Settings
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-privileges/"
        >
        <span class="label">Add Privileges / Roles
        </span>
      </a></li>
  </ul></li>
  </ul></li>
  </ul>
  </nav>
</div>


<main id="maincontent"><h1>&#34;Un-push&#34; Batch From Production</h1><p>Sometimes a batch is messed up enough that it needs to be completely removed,
rebuilt, and reingested, but it&rsquo;s already in production. In the (rare) cases
this happens <em>and</em> we haven&rsquo;t already archived all the original files, we can
un-push the batch and requeue the necessary issues.</p>
<p>This procedure helps &ldquo;un-push&rdquo; batches, but only when all of the following are true:</p>
<ul>
<li>The batch was created by NCA, not a vendor. There&rsquo;s currently no procedure
for reading a non-NCA batch and putting its issues in the database.</li>
<li>The batch is live, but hasn&rsquo;t been fully archived yet
<ul>
<li>In theory you could still do this after archival, but the work gets a lot
more involved and isn&rsquo;t in scope here.</li>
</ul>
</li>
<li>All issues are still in NCA&rsquo;s database and their files are still in the NCA
&ldquo;workflow&rdquo; location on disk (this is usually true until archival).</li>
</ul>
<p>This process is awful and you need to know what you&rsquo;re doing, but here&rsquo;s the rough outline:</p>
<ul>
<li>Turn off NCA&rsquo;s services (workers and http). If you can&rsquo;t do this, things
<em>will get messy</em> if you have a problem and have to rollback database or
filesystem changes.</li>
<li><strong>Back up your database!</strong> The filesystem may be too much to back up, so it
can be a pain if you need to fix something, but it&rsquo;s still really helpful to
at least have a &ldquo;good DB state&rdquo;.</li>
<li>Move your batch to the the &ldquo;ready for ingest&rdquo; location (e.g.,
<code>/mnt/news/outoging</code>) from wherever it goes to be archived</li>
<li>In the database, set the batch&rsquo;s <code>location</code> to the <em>full path</em> to the batch
you just copied
<ul>
<li>e.g., <code>/mnt/news/outgoing/batch_foo_20180918BasaltVampireTramplingCrabgrass_ver01</code></li>
</ul>
</li>
<li>&ldquo;Un-ignore&rdquo; the issues, clear their batch id, and set their state
&ldquo;ReadyForRebatching&rdquo; rather than the typical &ldquo;ReadyForBatching&rdquo;. This is
important to avoid accidentally putting these into new batches before you&rsquo;ve
fixed things.
<ul>
<li>e.g., <code>UPDATE issues SET batch_id = 0, ignored = 0, workflow_step = 'ReadyForRebatching' WHERE batch_id = ?</code></li>
<li>This isn&rsquo;t scary because you made a database backup. Right?</li>
</ul>
</li>
<li>Mark the batch &lsquo;deleted&rsquo;:
<ul>
<li><code>UPDATE batches SET location = '' AND status = 'deleted' WHERE id = ?</code></li>
<li>Still not scary.</li>
</ul>
</li>
<li>Do whatever fixes you need to (in our case, altering the <code>marc_org_code</code> for
a bunch of issues)</li>
<li>Create a new fixed-issue batch (or batches):
<ul>
<li><code>/path/to/nca/bin/queue-batches -c /path/to/nca/settings --redo</code></li>
<li>This will rebatch <em>all</em> issues at the <code>ReadyForRebatching</code> workflow step.
If you only process one problem batch at a time, though, this shouldn&rsquo;t do
anything but rebuild whatever was busted (meaning you may not need to re-QC
it, or if you do, it&rsquo;s at least an isolated set of issues).</li>
</ul>
</li>
<li>Purge the original batch from staging <strong>and</strong> production, then delete the
live batch files. <strong>Not</strong> the archived batch, just the live files (&ldquo;live&rdquo; as
defined in <code>BATCH_PRODUCTION_PATH</code>).
<ul>
<li>This seems scary, but at this point you still have the archival files
and a database backup.</li>
</ul>
</li>
<li>Make the new batch(es) live on staging and production.
<ul>
<li>See <a href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/">technical workflow</a> docs for information about batch management.</li>
</ul>
</li>
<li><strong>Delete your archived batch</strong>. This is the original batch you moved from the
archive location early in this process.
<ul>
<li>This is kind of scary, but you should now have a new batch (or multiple
batches) containing all the issues which were in the original batch. The
files are all the same, the database still has metadata, and the old
archive&rsquo;s only difference is whatever mistake you were rectifying.</li>
</ul>
</li>
</ul>
<nav class="pagination" aria-label="Pagination">

  <a class="nav nav-prev" href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-live-batches/">← Prev - Replacing Live Issues</a>

  <a class="nav nav-next" href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/">Next - Contributing →</a></nav>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>.
</footer>
      </main>
    </div>

  </div>
</body>
</html>
