<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Technical Details - Newspaper Curation App</title>
<meta name="description" content="Deeper explanation of NCA&#39;s various workflows">
<meta name="generator" content="Hugo 0.117.0">
<link rel="canonical" href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/theme.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/chroma.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/treeview-navigation.css">
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/headerlink.js"></script>
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/treeview-navigation.js"></script><meta property="og:title" content="Technical Details" />
<meta property="og:description" content="Deeper explanation of NCA&#39;s various workflows" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/" /><meta property="article:section" content="workflow" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Technical Details"/>
<meta name="twitter:description" content="Deeper explanation of NCA&#39;s various workflows"/>
<meta itemprop="name" content="Technical Details">
<meta itemprop="description" content="Deeper explanation of NCA&#39;s various workflows">

<meta itemprop="wordCount" content="1772">
<meta itemprop="keywords" content="" /></head>
<body>
  <div class="container"><div class="skip"><a href="#maincontent">Skip to main content</a></div>
<header>
<h1>Newspaper Curation App</h1><a href="https://github.com/uoregon-libraries/newspaper-curation-app/" class="github"><img src="https://uoregon-libraries.github.io/newspaper-curation-app/images/github-mark-white.svg" alt="NCA on Github"></a>
</header>
<div class="content-container"><div class="sidebar">
  
  <nav aria-labelledby="table-of-contents">
    <h2 id="table-of-contents" class="sr-only">Table Of Contents</h2>
    <ul class="treeview-navigation" role="tree" aria-label="Contents">
      <li role="none">
        <a role="treeitem"  href="https://uoregon-libraries.github.io/newspaper-curation-app/">
          <span class="label">Home</span>
        </a>
      </li><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/"
        aria-owns="subtree--newspaper-curation-app-setup-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Setup and Installation
        </span>
      </a><ul role="group" aria-label="Setup and Installation" id="subtree--newspaper-curation-app-setup-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/services/"
        >
        <span class="label">Services and Apps
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/server-setup/"
        >
        <span class="label">Server Setup
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/installation/"
        >
        <span class="label">Installation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/user-setup/"
        >
        <span class="label">Users
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/creating-publishers/"
        >
        <span class="label">Onboarding A Publisher
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/sftpgo-integration/"
        >
        <span class="label">SFTPGo Integration
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/"
        aria-owns="subtree--newspaper-curation-app-specs-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>NCA Terms, Specs, and Information
        </span>
      </a><ul role="group" aria-label="NCA Terms, Specs, and Information" id="subtree--newspaper-curation-app-specs-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/glossary/"
        >
        <span class="label">Glossary
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/upload-specs/"
        >
        <span class="label">Uploads: Folder and File Specs
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/"
        aria-owns="subtree--newspaper-curation-app-workflow-"
          aria-expanded="true">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Workflow
        </span>
      </a><ul role="group" aria-label="Workflow" id="subtree--newspaper-curation-app-workflow-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/"
        aria-current="page"
        >
        <span class="label">Technical Details
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/adding-titles/"
        >
        <span class="label">Adding Titles
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/handling-page-review-problems/"
        >
        <span class="label">Handling Page Review Problems
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-stuck-issues/"
        >
        <span class="label">Fixing &#34;Stuck&#34; Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-flagged-workflow-issues/"
        >
        <span class="label">Fixing Flagged Workflow Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-live-batches/"
        >
        <span class="label">Replacing Live Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/undo-batch-golive/"
        >
        <span class="label">&#34;Un-push&#34; Batch From Production
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/"
        aria-owns="subtree--newspaper-curation-app-contributing-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Contributing
        </span>
      </a><ul role="group" aria-label="Contributing" id="subtree--newspaper-curation-app-contributing-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-guide/"
        >
        <span class="label">Developer&#39;s Guide
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/not-compiling-locally/"
        >
        <span class="label">Not Compiling Locally
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/documentation/"
        >
        <span class="label">Contributing to Documentation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/testing/"
        >
        <span class="label">Testing
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/"
        aria-owns="subtree--newspaper-curation-app-contributing-dev-howto-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>How do I...?
        </span>
      </a><ul role="group" aria-label="How do I...?" id="subtree--newspaper-curation-app-contributing-dev-howto-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-job-types/"
        >
        <span class="label">Add Job Types
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-config-items/"
        >
        <span class="label">Add Configuration Settings
        </span>
      </a></li>
  </ul></li>
  </ul></li>
  </ul>
  </nav>
</div>


<main id="maincontent"><h1>Technical Details</h1><p>This document attempts to explain the entire workflow from upload to batch
generation in a way that developers can understand what&rsquo;s needed and how to at
least begin investigating if something goes wrong.</p>
<h2 id="jobs-and-the-job-queue">Jobs and the Job Queue</h2>
<p>The job runner regularly scans the database looking for jobs to run. The
default setup splits jobs up to ensure quick jobs, like moving an issue from
one location to another on the filesystem, are run separately from slow jobs
like generating JP2 files. This ensures that slow jobs don&rsquo;t hold up the
faster jobs, but could be confusing if you&rsquo;re expecting to see jobs run in the
order they are queued. It also tends to make raw job logs confusing. Grouping
jobs by pipeline can help simplify database-level job diagnostics.</p>
<p>The job runner also looks for issues in the scan and page review areas that
are ready to enter the workflow.</p>
<p>All jobs store logs in the database, but these are currently not exposed to end
users (not even admins). To help mitigate this, the job runner also logs to
STDERR, so those can be captured and reviewed.</p>
<h2 id="uploads">Uploads</h2>
<p>Whenever issues are uploaded into NCA, the application&rsquo;s &ldquo;Uploaded Issues&rdquo;
pages will display these issues along with any obvious errors the application
was able to detect. After a reasonable amount of time (to ensure uploading is
completed; some publishers slowly upload issue pages throughout the day, or
even multiple days), issues may be queued up for processing. Too-new issues
will be displayed, but queueing will be disabled.</p>
<p>Born-digital issues, when queued, are preprocessed (in order to ensure
derivatives can be generated, forcing one-pdf-per-page, etc.), then moved into
the page review area. The pages will be named sequentially in the format
<code>seq-dddd.pdf</code>, starting with <code>seq-0001.pdf</code>, then <code>seq-0002.pdf</code>, etc. These
PDFs might already be ordered correctly, but we&rsquo;ve found the need to manually
reorder them many times, and have decided an out-of-band process for reviewing
and reordering is necessary. An easy approach is to have somebody use
something like Adobe Bridge to review and rename in bulk. Once complete, an
issue&rsquo;s pages need to be ordered by their filenames, e.g., <code>0001.pdf</code>,
<code>0002.pdf</code>, etc. Until issues are all given a fully numeric name, the job
runner will not pick them up.</p>
<p><strong>Note</strong>: if issue folders are deleted from the page review location for any
reason, they must be cleaned up manually: <a href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/handling-page-review-problems/">Handling Page Review Problems</a>.
Once NCA is tracking uploads, deleting them outside the system will cause error
logs to go a bit haywire, and the issues can&rsquo;t be re-uploaded since NCA will
believe they quasi-exist.</p>
<p>For scanned issues, since they are in-house for us, it is assumed they&rsquo;re
already going to be properly named (<code>&lt;number&gt;.tif</code> and <code>&lt;number&gt;.pdf</code>) and
ordered, so after being queued they immediately get moved and processed for
derivatives.</p>
<p>The bulk upload queue tool (compiled to <code>bin/bulk-issue-queue</code>) can be used to
push all issues of a given type (scan vs. born digital) and issue key into the
workflow as if they&rsquo;d been queued from the web app. This tool should only be
run when people aren&rsquo;t using the NCA queueing front-end, as it will queue
things faster than the NCA cache will be updated, which can lead to NCA&rsquo;s web
view being out of sync with reality. The data will be intact, but it can be
confusing. Also note that for scanned issues, this tool can take a long time
because it verifies the DPI of all images embedded in PDFs.</p>
<h2 id="derivative-processing">Derivative Processing</h2>
<p>Once issues are ready for derivatives (born-digital issues have been queued,
pre-processed, and renamed; scanned issues have been queued and moved), a job
is queued for derivative processing. This creates JP2 images from either the
PDFs (born-digital) or TIFFs (scanned), and the ALTO-compatible OCR XML based
on the text in the PDF. In our process, the PDFs are created by OCRing the
TIFFs. This process is manual and out-of-band since we rely on Abbyy, and
there isn&rsquo;t a particularly easy way to integrate it into our workflow.</p>
<p>The derivative generation process is probably the slowest job in the system.
As such, it is particularly susceptible to things like server power outage. In
the event that a job is canceled mid-operation, somebody will have to modify
the database to change the job&rsquo;s status from <code>in_process</code> to <code>pending</code>.</p>
<p>The derivative jobs are very fault-tolerant:</p>
<ul>
<li>Derivatives are generated in a temporary location, and only moved into the
issue folder after the derivative has been generated successfully</li>
<li>Derivatives which were already created are not rebuilt</li>
</ul>
<p>These two factors make it easy to re-kick-off a derivative process without
worrying about data corruption.</p>
<h2 id="error-reports">Error Reports</h2>
<p>If an issue has some kind of problem which cannot be fixed with metadata entry,
the metadata person will report an error. Once an error is reported, the issue
will be hidden from all but Issue Managers in the NCA UI and one of them will
have to decide how to handle it. See <a href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-flagged-workflow-issues/">Fixing Flagged Workflow Issues</a>.</p>
<h2 id="post-metadata--batch-generation">Post-Metadata / Batch Generation</h2>
<p>After metadata has been entered and approved, the issue is considered &ldquo;done&rdquo;.
An issue XML will be generated (using the METS template defined by the setting
<code>METS_XML_TEMPLATE_PATH</code>) and born-digital issues&rsquo; original PDF(s) is/are moved
into the issue location for safe-keeping. Assuming these are done without
error, the issue is marked &ldquo;ready for batching&rdquo;.</p>
<p>The batch queue command-line script (compiled to <code>bin/queue-batches</code>) grabs all
issues which are ready to be batched, organizes them by MARC Org Code (a.k.a.,
awardee) for batching (<em>each awardee must have its issues in a separate
batch</em>), and generates batches if there are enough pages (see the
<code>MINIMUM_ISSUE_PAGES</code> setting).</p>
<p><strong>Note</strong>: the <code>MINIMUM_ISSUE_PAGES</code> setting will be ignored if any issues
waiting to be batched have been ready for batching for more than 30 days. This
is necessary to handle cases where an issue had to have special treatment after
the bulk of a batch was completed, and would otherwise just sit and wait
indefinitely.</p>
<h2 id="batch-management">Batch Management</h2>
<p>Once a batch is generated and all jobs related to it are complete, the files
will be put into the configured <code>BATCH_OUTPUT_PATH</code>, the live files (non-TIFF,
non-tar originals, etc.) are synced to the <code>BATCH_PRODUCTION_PATH</code>, and the
&ldquo;Batches&rdquo; page in NCA will show it to users with the &ldquo;batch loader&rdquo; role.</p>
<p>At this point the batch can be loaded into staging. NCA&rsquo;s batch page,
accessible by activating the relevant link in the batch list, will use your
configuration to provide bash commands that batch loaders can copy and paste in
order to get the batch onto your staging ONI instance.</p>
<p><em>Note: if your staging system mounts files differently than your NCA
server, the commands may have to be altered. e.g., NCA might use
<code>/mnt/news/outgoing</code> while staging uses <code>/mnt/libnca</code>.</em></p>
<p>Once loaded onto staging, the batch loader flags a batch as being ready for QC
(quality control). The batch will then be visible to batch reviewers, letting
them know action is needed to approve the batch. The batch page will have a
link to the staging environment&rsquo;s batch page for easier review, as well as two
possible actions to take: approve the batch for production or reject it from
staging due to problems in one or more issues.</p>
<p>If rejected, batch reviewers will need to find and flag the problem issues so
NCA can process the rest of the batch. Issues will be flagged as unfixable
(moving to a state where issue managers will have to take action), and the
batch reviewer will need to enter a comment to help identify what was wrong.
Once issues are done being flagged, the batch reviewer can finalize the batch,
rebuilding it with only the good issues, and moving it into the &ldquo;ready for
staging&rdquo; state, where a batch loader is guided through purging and reloading
the batch for another round of QC.</p>
<p>Once a batch has been approved in staging, NCA will mark the batch as ready to
go live. Upon visiting the batch page in NCA, the batch loader will get
instructions for loading the batch to production. <em>The same caveat applies here
as when loading to staging: if file mounts differ from NCA&rsquo;s mount locations,
the batch loader will need to adjust the commands NCA provides.</em></p>
<p>After batches are live, the batch loader flags it as such in NCA, and NCA will
move the original batch and any backups (the source PDFs for born-digital
batches, for instance) to the archival location specificed by the configured
<code>BATCH_ARCHIVE_PATH</code>. At this point the batch is ready for final archival.</p>
<h2 id="batch-archival">Batch Archival</h2>
<p>At UO, our archive path is actually a &ldquo;staging area&rdquo; for batches which are
getting ready for a move to the dark archive. Your process may not be quite the
same, but hopefully this is of help even if only to understand why NCA handles
batches the way it does.</p>
<p>Once we have enough content to justify a push to the dark archive, we move a
pile of batches from the staging area into the transfer area. Our archival team
runs the process (they generate their own manifests, for instance, and sync all
files to the archive). When they confirm that batches are archived, we flag
them in NCA as such.</p>
<p>Whether or not you follow that process, you will still need to specify an
archive path (<code>BATCH_ARCHIVE_PATH</code>) in your <code>settings</code> file and flag batches as
being live. Your archive path may be a direct mount to your final archive, a
location you manage manually, or some dummy location you simply delete if you
aren&rsquo;t preserving the original content for some reason.</p>
<p>Once flagged as archived, NCA stores the archival date and time. This is
important for knowing when it&rsquo;s safe to clean up the files. The issue deletion
script (<code>bin/delete-live-done-issues</code>, created by a standard <code>make</code> run) will
look for batches archived more than <strong>four weeks ago</strong> and then <em>completely
delete all files in NCA tied to these batches</em>. The files in your archive will
not be removed, of course, but NCA will ensure its workflow directories are
cleaned up to make room for new incoming files.</p>
<p>The four-week &ldquo;timer&rdquo; was originally put in place to ensure files have had a
chance to be fully backed up offsite, but it also serves another purpose: <em>it
gives you a chance to handle problems that weren&rsquo;t caught during the QC
process</em>. Once NCA&rsquo;s workflow files are removed, reprocessing a batch becomes
significantly more difficult.</p>
<p>Unless you have very few batches, very small batches, or a lot of disk space,
<code>bin/delete-live-done-issues</code> should be run regularly to avoid running out of
storage. NCA can handle most problems gracefully, but running out of storage
is almost guaranteed to cause you some headaches.</p>
<nav class="pagination" aria-label="Pagination">

  <a class="nav nav-prev" href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/">← Prev - Workflow</a>

  <a class="nav nav-next" href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/adding-titles/">Next - Adding Titles →</a></nav>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>.
</footer>
      </main>
    </div>

  </div>
</body>
</html>
