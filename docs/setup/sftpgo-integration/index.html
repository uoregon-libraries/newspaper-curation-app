<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SFTPGo Integration - Newspaper Curation App</title>
<meta name="description" content="Setting up NCA for SFTPGo integration">
<meta name="generator" content="Hugo 0.117.0">
<link rel="canonical" href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/sftpgo-integration/">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/theme.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/chroma.css">
<link rel="stylesheet" href="https://uoregon-libraries.github.io/newspaper-curation-app/css/treeview-navigation.css">
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/headerlink.js"></script>
<script src="https://uoregon-libraries.github.io/newspaper-curation-app/js/treeview-navigation.js"></script><meta property="og:title" content="SFTPGo Integration" />
<meta property="og:description" content="Setting up NCA for SFTPGo integration" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uoregon-libraries.github.io/newspaper-curation-app/setup/sftpgo-integration/" /><meta property="article:section" content="setup" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SFTPGo Integration"/>
<meta name="twitter:description" content="Setting up NCA for SFTPGo integration"/>
<meta itemprop="name" content="SFTPGo Integration">
<meta itemprop="description" content="Setting up NCA for SFTPGo integration">

<meta itemprop="wordCount" content="1043">
<meta itemprop="keywords" content="" /></head>
<body>
  <div class="container"><div class="skip"><a href="#maincontent">Skip to main content</a></div>
<header>
<h1>Newspaper Curation App</h1><a href="https://github.com/uoregon-libraries/newspaper-curation-app/" class="github"><img src="https://uoregon-libraries.github.io/newspaper-curation-app/images/github-mark-white.svg" alt="NCA on Github"></a>
</header>
<div class="content-container"><div class="sidebar">
  
  <nav aria-labelledby="table-of-contents">
    <h2 id="table-of-contents" class="sr-only">Table Of Contents</h2>
    <ul class="treeview-navigation" role="tree" aria-label="Contents">
      <li role="none">
        <a role="treeitem"  href="https://uoregon-libraries.github.io/newspaper-curation-app/">
          <span class="label">Home</span>
        </a>
      </li><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/"
        aria-owns="subtree--newspaper-curation-app-setup-"
          aria-expanded="true">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Setup and Installation
        </span>
      </a><ul role="group" aria-label="Setup and Installation" id="subtree--newspaper-curation-app-setup-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/services/"
        >
        <span class="label">Services and Apps
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/server-setup/"
        >
        <span class="label">Server Setup
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/installation/"
        >
        <span class="label">Installation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/user-setup/"
        >
        <span class="label">Users
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/creating-publishers/"
        >
        <span class="label">Onboarding A Publisher
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/sftpgo-integration/"
        aria-current="page"
        >
        <span class="label">SFTPGo Integration
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/"
        aria-owns="subtree--newspaper-curation-app-specs-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>NCA Terms, Specs, and Information
        </span>
      </a><ul role="group" aria-label="NCA Terms, Specs, and Information" id="subtree--newspaper-curation-app-specs-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/glossary/"
        >
        <span class="label">Glossary
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/upload-specs/"
        >
        <span class="label">Uploads: Folder and File Specs
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/"
        aria-owns="subtree--newspaper-curation-app-workflow-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Workflow
        </span>
      </a><ul role="group" aria-label="Workflow" id="subtree--newspaper-curation-app-workflow-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/technical/"
        >
        <span class="label">Technical Details
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/adding-titles/"
        >
        <span class="label">Adding Titles
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/handling-page-review-problems/"
        >
        <span class="label">Handling Page Review Problems
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-stuck-issues/"
        >
        <span class="label">Fixing &#34;Stuck&#34; Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-flagged-workflow-issues/"
        >
        <span class="label">Fixing Flagged Workflow Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/fixing-live-batches/"
        >
        <span class="label">Replacing Live Issues
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/workflow/undo-batch-golive/"
        >
        <span class="label">&#34;Un-push&#34; Batch From Production
        </span>
      </a></li>
  </ul></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/"
        aria-owns="subtree--newspaper-curation-app-contributing-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>Contributing
        </span>
      </a><ul role="group" aria-label="Contributing" id="subtree--newspaper-curation-app-contributing-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-guide/"
        >
        <span class="label">Developer&#39;s Guide
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/not-compiling-locally/"
        >
        <span class="label">Not Compiling Locally
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/documentation/"
        >
        <span class="label">Contributing to Documentation
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/testing/"
        >
        <span class="label">Testing
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/"
        aria-owns="subtree--newspaper-curation-app-contributing-dev-howto-"
          aria-expanded="false">
        <span class="label"><span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 24 24">
              <polygon points="2,3 22,11 2,20"></polygon>
            </svg>
          </span>How do I...?
        </span>
      </a><ul role="group" aria-label="How do I...?" id="subtree--newspaper-curation-app-contributing-dev-howto-"><li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-job-types/"
        >
        <span class="label">Add Job Types
        </span>
      </a></li>
  <li role="none">
      <a
        role="treeitem"
        href="https://uoregon-libraries.github.io/newspaper-curation-app/contributing/dev-howto/add-config-items/"
        >
        <span class="label">Add Configuration Settings
        </span>
      </a></li>
  </ul></li>
  </ul></li>
  </ul>
  </nav>
</div>


<main id="maincontent"><h1>SFTPGo Integration</h1><p><a href="https://github.com/drakkan/sftpgo">SFTPGo</a> is an sftp server that exposes APIs
and a web interface for administration tasks.  We&rsquo;ve chosen to integrate NCA
with SFTPGo in order to simplify the process of creating titles for a publisher
that&rsquo;s uploading newspaper PDFs.</p>
<p>If you choose not to use this integration, publisher uploads will have to be
managed entirely by you (as was the case prior to this integration), and NCA
will not track SFTP data (which is a change from NCA 3.x and prior).</p>
<h2 id="opt-out">Opt out</h2>
<p>To disable SFTPGo integration, assign &ldquo;-&rdquo; to the <code>SFTPGO_API_URL</code> setting:</p>
<pre><code>SFTPGO_API_URL=&quot;-&quot;
</code></pre>
<p>This ensures that NCA will not try to connect to a nonexistent server.</p>
<h2 id="sftpgo-setup">SFTPGo Setup</h2>
<p>If you do opt to use SFTPGo, you&rsquo;ll need to use the SFTPGo documentation to set
it up however it makes sense for your system. Once that&rsquo;s done, you have to
then make NCA aware of it.</p>
<p>Our configuration files can be found in the NCA project&rsquo;s root under the
<code>sftpgo</code> directory. It&rsquo;s obviously somewhat specific to our bare-metal RHEL
system, but they should help get you up and running.</p>
<p>We use nginx to proxy the SFTPGo web interface. This isn&rsquo;t necessary &ndash; SFTPGo
can be exposed directly. We prefer the granular control nginx gives us (e.g.,
being able to lock down certain paths by IP).</p>
<p>For the sftp daemon itself, we just expose that directly.</p>
<p>Install nginx, configure it (again, see our configuration if necessary), and
then install SFTPGo as a service. See the <a href="https://github.com/drakkan/sftpgo/blob/main/docs/service.md">&ldquo;Running SFTPGo as a service&rdquo;</a>
page in the official SFTPGo documentation.</p>
<p>SFTPGo configuration: unless you&rsquo;re a masochist, don&rsquo;t try to adapt the huge
<code>sftpgo.json</code> file to your needs only to wonder &ldquo;what did we change again?&rdquo; the
next time SFTPGo is updated. Use an environment file (<code>/etc/sftpgo.env</code>) and
set only those configuration options you need to change. On Linux, SFTPGo&rsquo;s
systemd unit file automatically loads those environment variables on startup.
Make sure you understand how the environment overrides work (see &ldquo;Environment
variables&rdquo; on the <a href="https://github.com/drakkan/sftpgo/blob/main/docs/full-configuration.md">&ldquo;Configuring SFTPGo&rdquo;</a> page) if you need to add your own
settings.</p>
<p>Don&rsquo;t try to skimp on the proxy settings. If you are using nginx and you don&rsquo;t
use <strong>all four</strong> proxy settings we put in our <code>sftpgo.env</code> file, you&rsquo;ll drown
in weird form token errors when you try to log in.</p>
<p>If you&rsquo;re using docker, an admin user (login: <code>admin</code>, password: <code>password</code>) is
created for you automatically, but is extremely insecure: you must change the
default admin user&rsquo;s password at a minimum, or better yet use a docker override
to set up an admin that has a unique name <em>and</em> a good password.</p>
<p>If you aren&rsquo;t using docker, you will need an admin user. The first time you
connect to the SFTPGo web UI, you will be required to create an admin account,
though you can also use the <code>create_default_admin</code> SFTPGo setting to
automatically create one when sftpgo first runs. See the &ldquo;Configuration file&rdquo;
section of the SFTPGo configuration documentation for details.</p>
<h2 id="nca-setup">NCA Setup</h2>
<p>Open up your settings file and jump to the SFTPGo section. If you&rsquo;re upgrading
from an older version of NCA, you will have to copy this section from the
example settings file into your production settings.</p>
<p>You&rsquo;ll need to tell NCA how to connect to SFTPGo: set the API URL and choose a
default quota for new users.</p>
<p>The API endpoint is simply the SFTPGo host combined with the path <code>/api/v2</code>.
For our docker setup, the internal service is <code>http://sftpgo:8080</code>, so our API
configuration looks like this:</p>
<pre><code>SFTPGO_API_URL=&quot;http://sftpgo:8080/api/v2&quot;
</code></pre>
<p>The default quota is five gigabytes, but you can adjust this as needed. You
will likely want <em>something</em>, however: this ensures one publisher can&rsquo;t blast
hundreds of gigs (or even terabytes) of data, taking your server down and
preventing all other publishers from uploading anything.</p>
<h3 id="sftpgo-api-key">SFTPGo API Key</h3>
<p>NCA connects to SFTPGo via an API key for a user with admin privileges. If you
are using Docker with defaults for development, this API key is created and
assigned in your NCA <code>settings</code> file automatically. For any non-docker use,
one will have to use the Bash scripts in the <code>sftpgo/</code> directory. You will need
to provide the environment variable <code>SETTINGS_PATH</code> with a value corresponding
to the path to your NCA <code>settings</code> file to these Bash scripts.
<code>SETTINGS_PATH=/path/to/settings sftpgo/get_admin_api_key.sh</code> is the only script
that <em>must</em> be run. It will prompt for admin user credentials, use them to
request an API key for that user, store the key in the NCA <code>settings</code> file
automatically, and then call the accompanying script <code>test_api_key.sh</code> to test
that API key.</p>
<p>Normally you only run <code>get_admin_api_key.sh</code> once, but if you need to reacquire
a key, you must reset your <code>settings</code> file (set
<code>SFTPGO_ADMIN_API_KEY=!sftpgo_admin_api_key!</code>) and then re-run this script.</p>
<p>Note that you can instead run <code>get_admin_api_key.sh</code> with the <code>--force</code> flag to
overwrite an existing key in your <code>settings</code> file. This should rarely be
necessary in a production environment, but can be useful on a development or
staging system where the stack may be destroyed and rebuilt regularly.</p>
<p>Other accompanying scripts are provided to list all API keys and delete an API
key.</p>
<h2 id="usage">Usage</h2>
<p>Once SFTPGo is integrated, any titles created in NCA will be sent to SFTPGo.
If you had been doing sftp the traditional way (local accounts using ssh with
the login shell disabled), you will find that a big advantage to SFTPGo is that
it doesn&rsquo;t need a local system administrator to manage users, quotas, etc.
Provisioning accounts will be automated from NCA, and management can be done
using the SFTPGo web API or the REST endpoints.</p>
<h2 id="bulk-loading">Bulk loading</h2>
<p>If you were already managing SFTP uploads and you don&rsquo;t want to redo all that
work, NCA can help!  On startup, NCA will scan the <code>titles</code> database table.
Any title that (a) is not SFTPGo-connected, and (b) has values for both the
<code>sftp_user</code> and <code>sftp_pass</code> fields will get sent to SFTPGo in the background.
These SFTP accounts will get the default quota applied, which can then be
edited on an individual basis from NCA.</p>
<p><strong>Note</strong>: for security reasons, titles&rsquo; passwords will be removed upon
successful integration with SFTPGo.  <em>(Storing plaintext passwords was supposed
to stop happening a long time ago)</em></p>
<p><strong>Advanced users</strong> can even populate the NCA <code>titles</code> table manually in order
to bulk-load SFTP users which weren&rsquo;t being managed by NCA.</p>
<nav class="pagination" aria-label="Pagination">

  <a class="nav nav-prev" href="https://uoregon-libraries.github.io/newspaper-curation-app/setup/creating-publishers/">← Prev - Onboarding A Publisher</a>

  <a class="nav nav-next" href="https://uoregon-libraries.github.io/newspaper-curation-app/specs/">Next - NCA Terms, Specs, and Information →</a></nav>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>.
</footer>
      </main>
    </div>

  </div>
</body>
</html>
